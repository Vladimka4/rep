{% extends "base.html" %}

{% block title %}{{ category.name }} - Food Delivery{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1>{{ category.name }}</h1>
        <p class="lead">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–µ—Å—è –±–ª—é–¥–∞</p>
    </div>
</div>

<div class="row">
    {% for dish in dishes %}
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <img src="{% if dish.image %}{{ url_for('static', filename='images/' + dish.image) }}{% else %}https://via.placeholder.com/300?text=–ë–µ–∑+–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è{% endif %}" 
                 class="card-img-top" alt="{{ dish.name }}" style="height: 200px; object-fit: cover;">
            <div class="card-body d-flex flex-column">
                <h5 class="card-title">{{ dish.name }}</h5>
                <p class="card-text">{{ dish.description }}</p>
                <div class="mt-auto">
                    <p class="card-text fw-bold fs-4">{{ dish.price }} ‚ÇΩ</p>
                    
                    <div class="d-flex justify-content-between">
                        <button class="btn btn-primary add-to-cart" data-dish-id="{{ dish.id }}">
                            –í –∫–æ—Ä–∑–∏–Ω—É
                        </button>
                        
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-outline-danger favorite-btn" data-dish-id="{{ dish.id }}">
                            {% if dish.id in favorite_ids %}
                            <span class="favorite-icon">‚ù§Ô∏è</span>
                            {% else %}
                            <span class="favorite-icon">ü§ç</span>
                            {% endif %}
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% if not dishes %}
<div class="text-center py-5">
    <h3>–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç –±–ª—é–¥</h3>
    <p class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</p>
    <a href="{{ url_for('main.index') }}" class="btn btn-primary mt-3">
        –ù–∞ –≥–ª–∞–≤–Ω—É—é
    </a>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É
    document.querySelectorAll('.add-to-cart').forEach(button => {
        button.addEventListener('click', function() {
            const dishId = this.dataset.dishId;
            
            fetch(`/add_to_cart/${dishId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ—Ä–∑–∏–Ω—ã
                    const cartCount = document.querySelector('#cart-count');
                    if (cartCount) {
                        cartCount.textContent = data.cart_total;
                    } else {
                        // –°–æ–∑–¥–∞–µ–º –±–µ–π–¥–∂ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                        const cartBtn = document.querySelector('a[href="/cart"]');
                        if (cartBtn) {
                            const badge = document.createElement('span');
                            badge.id = 'cart-count';
                            badge.className = 'position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger';
                            badge.textContent = data.cart_total;
                            cartBtn.appendChild(badge);
                        }
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    showAlert(data.message, 'success');
                } else {
                    showAlert(data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É', 'danger');
            });
        });
    });
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
    document.querySelectorAll('.favorite-btn').forEach(button => {
        button.addEventListener('click', function() {
            const dishId = this.dataset.dishId;
            const icon = this.querySelector('.favorite-icon');
            
            fetch(`/add_to_favorites/${dishId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.action === 'added') {
                        icon.textContent = '‚ù§Ô∏è';
                        this.classList.add('btn-danger');
                        this.classList.remove('btn-outline-danger');
                    } else {
                        icon.textContent = 'ü§ç';
                        this.classList.remove('btn-danger');
                        this.classList.add('btn-outline-danger');
                    }
                    showAlert(data.message, 'success');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('–û—à–∏–±–∫–∞', 'danger');
            });
        });
    });
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.parentNode.removeChild(alertDiv);
            }
        }, 3000);
    }
});
</script>
{% endblock %}
