{% extends 'base.html' %}

{% block title %}Парсинг меню - Админ{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-download me-2"></i>Парсинг меню ресторана "На Старом Месте"</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <strong><i class="fas fa-info-circle me-1"></i>Информация:</strong><br>
                    • Сайт: nsm-22.ru<br>
                    • Автоматически определяются все разделы меню<br>
                    • <strong>Новая система:</strong> URL изображений сохраняются в очередь для загрузки<br>
                    • <strong>Фильтрация:</strong> Блюда с ценой 0 или без цены автоматически удаляются
                </div>
                
                <!-- Статистика очереди -->
                <div id="queue-stats" class="card mb-4">
                    <div class="card-header bg-warning">
                        <h6 class="mb-0"><i class="fas fa-tasks me-1"></i> Статистика очереди изображений</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3 mb-3">
                                <div class="bg-light p-3 rounded">
                                    <h3 id="queue-total">0</h3>
                                    <small class="text-muted">Всего задач</small>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="bg-info text-white p-3 rounded">
                                    <h3 id="queue-pending">0</h3>
                                    <small>Ожидают</small>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="bg-success text-white p-3 rounded">
                                    <h3 id="queue-completed">0</h3>
                                    <small>Завершено</small>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="bg-danger text-white p-3 rounded">
                                    <h3 id="queue-failed">0</h3>
                                    <small>Ошибок</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Форма для парсинга текста -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">Парсинг текста меню</h6>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('admin_parsing.parse_nsm_action') }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            
                            <div class="mb-3">
                                <label class="form-label">URL главной страницы (опционально)</label>
                                <input type="url" class="form-control" name="base_url" 
                                       value="https://nsm-22.ru/" placeholder="https://nsm-22.ru/">
                                <small class="form-text text-muted">
                                    Оставьте значение по умолчанию для парсинга всего меню
                                </small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Или выберите конкретный раздел</label>
                                <select class="form-control" name="specific_section">
                                    <option value="">Весь сайт (автоматический поиск)</option>
                                    <option value="https://nsm-22.ru/salaty/">Салаты</option>
                                    <option value="https://nsm-22.ru/zakuski/">Закуски</option>
                                    <option value="https://nsm-22.ru/goryachie-zakuski/">Горячие закуски</option>
                                    <option value="https://nsm-22.ru/supy/">Супы</option>
                                    <option value="https://nsm-22.ru/pasta/">Паста</option>
                                    <option value="https://nsm-22.ru/ryba/">Рыба</option>
                                    <option value="https://nsm-22.ru/myaso-i-ptitsa/">Мясо и птица</option>
                                    <option value="https://nsm-22.ru/deserty/">Десерты</option>
                                </select>
                            </div>
                            
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                <strong>Внимание:</strong> При парсинге URL изображений будут сохранены в очередь для последующей загрузки
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-download me-1"></i> Парсить текст меню
                            </button>
                        </form>
                    </div>
                </div>
                
                <!-- Управление очередью изображений -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="fas fa-images me-1"></i> Управление очередью изображений</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h6>Обработка очереди</h6>
                                        <p class="text-muted small">Загружает изображения из очереди</p>
                                        <form method="POST" action="{{ url_for('admin_parsing.process_image_queue') }}" 
                                              class="mb-0">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <div class="mb-3">
                                                <label class="form-label">Количество для обработки</label>
                                                <input type="number" class="form-control" name="limit" 
                                                       value="5" min="1" max="20">
                                            </div>
                                            <div class="mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" 
                                                           name="cleanup" id="cleanup" checked>
                                                    <label class="form-check-label" for="cleanup">
                                                        Очищать старые задачи
                                                    </label>
                                                </div>
                                            </div>
                                            <button type="submit" class="btn btn-success w-100">
                                                <i class="fas fa-play me-1"></i> Обработать очередь
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h6>Очистка очереди</h6>
                                        <p class="text-muted small">Удаляет все задачи из очереди</p>
                                        <form method="POST" action="{{ url_for('admin_parsing.clear_image_queue') }}" 
                                              class="mb-0"
                                              onsubmit="return confirm('Вы уверены? Все задачи в очереди будут удалены.');">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <div class="alert alert-danger">
                                                <i class="fas fa-exclamation-triangle me-1"></i>
                                                Это действие нельзя отменить
                                            </div>
                                            <button type="submit" class="btn btn-danger w-100">
                                                <i class="fas fa-trash me-1"></i> Очистить очередь
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <strong><i class="fas fa-lightbulb me-1"></i> Как это работает:</strong><br>
                            1. При парсинге URL изображений сохраняются в очередь (таблица ImageQueue)<br>
                            2. Система обрабатывает очередь, загружая изображения по одному<br>
                            3. После успешной загрузки задача удаляется из очереди<br>
                            4. Ошибки автоматически повторяются (до 3 раз)
                        </div>
                    </div>
                </div>
                
                <!-- Форма для обновления изображений категорий -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fas fa-images me-1"></i> Обновление изображений категорий</h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <strong><i class="fas fa-lightbulb me-1"></i> Как это работает:</strong><br>
                            1. Система найдет для каждой категории первое блюдо с изображением<br>
                            2. Изображение этого блюда будет установлено как изображение категории<br>
                            3. Это улучшит отображение категорий на главной странице<br>
                            4. <strong>Важно:</strong> Сначала должны быть спарсены блюда с изображениями
                        </div>
                        
                        <form method="POST" action="{{ url_for('admin_parsing.update_category_images') }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                <strong>Рекомендация:</strong> Выполняйте эту операцию после обработки очереди изображений.
                            </div>
                            
                            <button type="submit" class="btn btn-info w-100" 
                                    onclick="return confirm('Обновить изображения категорий? Это займет несколько секунд.')">
                                <i class="fas fa-sync-alt me-1"></i> Обновить изображения категорий
                            </button>
                        </form>
                    </div>
                </div>
                
                <div class="mt-3">
                    <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-1"></i> На главную
                    </a>
                    <a href="/admin/imagequeue/" class="btn btn-outline-primary ms-2">
                        <i class="fas fa-list me-1"></i> Просмотреть очередь
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Функция для загрузки статистики очереди
    function loadQueueStats() {
        fetch('/admin-parsing/queue-stats')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Ошибка загрузки статистики:', data.error);
                    return;
                }
                
                // Обновляем статистику
                document.getElementById('queue-total').textContent = data.total || 0;
                document.getElementById('queue-pending').textContent = data.pending || 0;
                document.getElementById('queue-completed').textContent = data.completed || 0;
                document.getElementById('queue-failed').textContent = data.failed || 0;
                
                // Показываем/скрываем блок статистики в зависимости от наличия задач
                const queueStatsDiv = document.getElementById('queue-stats');
                if (data.total > 0) {
                    queueStatsDiv.style.display = 'block';
                } else {
                    queueStatsDiv.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Ошибка загрузки статистики:', error);
            });
    }
    
    // Загружаем статистику при загрузке страницы
    loadQueueStats();
    
    // Обновляем статистику каждые 10 секунд
    setInterval(loadQueueStats, 10000);
    
    // Обновляем статистику после выполнения действий
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function() {
            setTimeout(() => {
                loadQueueStats();
            }, 3000);
        });
    });
});
</script>
{% endblock %}